<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Caixa Academia</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body{margin:0;font-family:Segoe UI;background:#0f172a;color:#e5e7eb}
header{background:#020617;padding:15px;display:flex;justify-content:space-between;align-items:center}
.container{max-width:1200px;margin:auto;padding:20px}
.card{background:#020617;border-radius:10px;padding:20px;margin-bottom:20px}
input,button{padding:10px;border-radius:6px;border:none}
input{width:100%;margin-bottom:10px;background:#1e293b;color:#e5e7eb}
button{background:#2563eb;color:#fff;cursor:pointer}
button.warn{background:#f59e0b}
button.danger{background:#dc2626}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #1e293b;text-align:center}
.hidden{display:none}
.alerta{background:#7c2d12;padding:15px;border-radius:8px;margin-bottom:20px}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login" class="container">
  <div class="card" style="max-width:400px;margin:auto">
    <img src="logo.png" style="width:120px;display:block;margin:auto">
    <h3>Login</h3>
    <input id="user" placeholder="Usu치rio">
    <input id="pass" type="password" placeholder="Senha">
    <button id="btnLogin">Entrar</button>
  </div>
</div>

<!-- SISTEMA -->
<div id="sistema" class="hidden">
<header>
  <strong id="infoUser"></strong>
  <button id="btnLogout">Logout</button>
</header>

<div class="container">

<div id="alertaAtraso" class="alerta hidden"></div>

<!-- CADASTRO DE ALUNO -->
<div class="card">
  <h3>Cadastrar Aluno</h3>
  <input id="nomeAluno" placeholder="Nome do aluno">
  <input id="valorAluno" placeholder="Mensalidade (R$)" type="number">
  <input id="vencimentoAluno" placeholder="Dia de vencimento (1 a 28)" type="number" min="1" max="28">
  <button id="btnCadastrar">Cadastrar</button>
</div>

<!-- LISTA DE ALUNOS -->
<div class="card">
  <h3>Lista de Alunos</h3>
  <table>
    <thead>
      <tr><th>Aluno</th><th>Mensalidade</th><th>Status</th><th>A칞칫es</th></tr>
    </thead>
    <tbody id="listaAlunos"></tbody>
  </table>
</div>

<!-- A칂칏ES -->
<div class="card">
  <button id="btnPDF">游늯 Relat칩rio Mensal (PDF)</button>
  <button id="btnFechar" class="danger">游 Fechar Caixa</button>
</div>

</div>
</div>

<script>
const { jsPDF } = window.jspdf;

// --- USU츼RIOS ---
const users = [
  {user:"admin", pass:"1234"},
  {user:"funcionario", pass:"123"}
];

// --- VARI츼VEIS ---
let usuario = null;
let alunos = JSON.parse(localStorage.getItem("alunos")) || [];
let caixaAberto = localStorage.getItem("caixa") !== "fechado";

// --- ELEMENTOS ---
const loginDiv = document.getElementById("login");
const sistemaDiv = document.getElementById("sistema");
const infoUser = document.getElementById("infoUser");
const btnLogin = document.getElementById("btnLogin");
const btnLogout = document.getElementById("btnLogout");
const btnCadastrar = document.getElementById("btnCadastrar");
const btnPDF = document.getElementById("btnPDF");
const btnFechar = document.getElementById("btnFechar");
const listaAlunos = document.getElementById("listaAlunos");
const alertaAtraso = document.getElementById("alertaAtraso");

// --- LOGIN ---
btnLogin.addEventListener("click", () => {
  const username = document.getElementById("user").value.trim();
  const password = document.getElementById("pass").value.trim();

  if(!username || !password){ alert("Preencha usu치rio e senha!"); return; }

  const ok = users.find(u => u.user === username && u.pass === password);
  if(!ok){ alert("Login inv치lido"); return; }

  usuario = ok;
  loginDiv.style.display = "none";
  sistemaDiv.classList.remove("hidden");
  infoUser.innerText = "Usu치rio: " + usuario.user;

  atualizar();
  verificarAtrasos();
});

// Logout
btnLogout.addEventListener("click", () => {
  loginDiv.style.display = "block";
  sistemaDiv.classList.add("hidden");
  document.getElementById("user").value = "";
  document.getElementById("pass").value = "";
});

// --- CADASTRO DE ALUNO ---
btnCadastrar.addEventListener("click", () => {
  const nome = document.getElementById("nomeAluno").value.trim();
  const valor = Number(document.getElementById("valorAluno").value);
  const vencimento = Number(document.getElementById("vencimentoAluno").value);

  if(!nome || !valor || !vencimento){ alert("Preencha todos os campos corretamente!"); return; }

  alunos.push({ nome, valor, vencimento, ultimoPagamento: null });
  salvar();

  document.getElementById("nomeAluno").value = "";
  document.getElementById("valorAluno").value = "";
  document.getElementById("vencimentoAluno").value = "";

  atualizar();
  verificarAtrasos();
});

// --- PAGAMENTO ---
function receber(i){
  if(!caixaAberto){ alert("Caixa fechado!"); return; }
  alunos[i].ultimoPagamento = new Date().toISOString();
  salvar();
  atualizar();
  verificarAtrasos();
}

// --- VERIFICAR ATRASOS ---
function verificarAtrasos(){
  const hoje = new Date();
  let atrasados = [];

  alunos.forEach(a=>{
    const ult = a.ultimoPagamento ? new Date(a.ultimoPagamento) : null;
    const venc = new Date(hoje.getFullYear(), hoje.getMonth(), a.vencimento);

    if(!ult || (ult < venc && hoje > venc)){
      const dias = ult ? Math.floor((hoje-venc)/86400000) : Math.floor((hoje-venc)/86400000);
      atrasados.push({...a,dias});
    }
  });

  if(atrasados.length){
    alertaAtraso.classList.remove("hidden");
    alertaAtraso.innerHTML = "<strong>丘멆잺 Alunos em atraso:</strong><br>";
    atrasados.forEach(a=>{
      alertaAtraso.innerHTML += `${a.nome} - ${a.dias} dias <button class="warn" onclick="cobrar('${a.nome}')">Cobrar</button><br>`;
    });
  } else alertaAtraso.classList.add("hidden");
}

// --- COBRAN칂A WHATSAPP ---
function cobrar(nome){
  const msg = `Ol치 ${nome}, identificamos que sua mensalidade est치 em atraso. Por favor regularize para evitar o cancelamento da matr칤cula.`;
  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank");
}

// --- GERAR PDF ---
btnPDF.addEventListener("click", ()=>{
  const pdf = new jsPDF();
  let y=10;
  pdf.text("Relat칩rio Mensal - Academia", 10, y); y+=10;
  alunos.forEach(a=>{
    pdf.text(`${a.nome} | R$ ${a.valor.toFixed(2)}`, 10, y);
    y+=7;
  });
  pdf.save("relatorio_mensal.pdf");
});

// --- FECHAR CAIXA ---
btnFechar.addEventListener("click", ()=>{
  if(!confirm("Fechar caixa do dia?")) return;
  caixaAberto = false;
  localStorage.setItem("caixa","fechado");
  alert("Caixa fechado");
});

// --- ATUALIZAR LISTA ---
function atualizar(){
  listaAlunos.innerHTML = "";
  const hoje = new Date();
  alunos.forEach((a,i)=>{
    let status="Em dia";
    const ult = a.ultimoPagamento ? new Date(a.ultimoPagamento) : null;
    const venc = new Date(hoje.getFullYear(), hoje.getMonth(), a.vencimento);
    if(!ult || (ult < venc && hoje>venc)) status="丘멆잺 Atrasado";

    listaAlunos.innerHTML += `
    <tr>
      <td>${a.nome}</td>
      <td>R$ ${a.valor.toFixed(2)}</td>
      <td>${status}</td>
      <td>
        <button onclick="receber(${i})">Receber</button>
        <button class="warn" onclick="cobrar('${a.nome}')">Cobrar</button>
      </td>
    </tr>`;
  });
}

// --- SALVAR LOCALSTORAGE ---
function salvar(){
  localStorage.setItem("alunos", JSON.stringify(alunos));
}
</script>
</body>
</html>
