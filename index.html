<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Financeiro Academia ‚Ä¢ Controle de Caixa</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#0c1629;
      --card:#0f1f3a;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --line:rgba(148,163,184,.18);
      --brand:#22c55e;
      --brand2:#3b82f6;
      --warn:#f59e0b;
      --danger:#ef4444;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans);
      background: radial-gradient(1000px 600px at 10% -10%, rgba(59,130,246,.25), transparent 55%),
                  radial-gradient(900px 520px at 90% 0%, rgba(34,197,94,.18), transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .app{display:flex; min-height:100vh}
    .sidebar{
      width:280px; padding:18px 16px; border-right:1px solid var(--line);
      background: linear-gradient(180deg, rgba(15,26,46,.85), rgba(11,18,32,.85));
      position:sticky; top:0; height:100vh;
    }
    .brand{
      display:flex; align-items:center; gap:12px; padding:10px 10px 14px;
      border-bottom:1px solid var(--line);
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(59,130,246,.95));
      display:grid; place-items:center; box-shadow: var(--shadow);
      font-weight:800;
    }
    .brand h1{margin:0;font-size:14px;line-height:1.2}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted)}
    .nav{margin-top:14px; display:flex; flex-direction:column; gap:6px;}
    .nav button{
      all:unset; cursor:pointer;
      padding:10px 12px; border-radius:14px;
      display:flex; align-items:center; gap:10px;
      color:rgba(229,231,235,.9);
      border:1px solid transparent;
      transition:.15s;
    }
    .nav button:hover{background:rgba(148,163,184,.08); border-color:rgba(148,163,184,.12)}
    .nav button.active{background:rgba(59,130,246,.14); border-color:rgba(59,130,246,.25)}
    .badge{
      margin-left:auto;
      font-size:12px; color:rgba(229,231,235,.9);
      background:rgba(239,68,68,.18);
      border:1px solid rgba(239,68,68,.25);
      padding:3px 8px; border-radius:999px;
    }
    .sidebar .foot{
      position:absolute; bottom:16px; left:16px; right:16px;
      padding-top:14px; border-top:1px solid var(--line);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .pill{
      font-family:var(--mono);
      font-size:11px; color:rgba(229,231,235,.75);
      padding:6px 10px; border-radius:999px;
      background:rgba(148,163,184,.08); border:1px solid rgba(148,163,184,.12);
      white-space:nowrap;
    }
    .btn{
      border:none; cursor:pointer;
      border-radius:14px; padding:10px 12px;
      font-weight:700;
      background:rgba(148,163,184,.10);
      border:1px solid rgba(148,163,184,.14);
      color:var(--text);
      transition:.15s;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{
      background:rgba(34,197,94,.18);
      border-color:rgba(34,197,94,.26);
    }
    .btn.blue{
      background:rgba(59,130,246,.18);
      border-color:rgba(59,130,246,.26);
    }
    .btn.danger{
      background:rgba(239,68,68,.18);
      border-color:rgba(239,68,68,.26);
    }
    .btn.warn{
      background:rgba(245,158,11,.18);
      border-color:rgba(245,158,11,.26);
    }

    .main{flex:1; padding:18px 18px 30px;}
    .topbar{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center; justify-content:space-between;
      margin-bottom:14px;
    }
    .topbar .left{display:flex; gap:10px; align-items:center}
    .topbar h2{margin:0;font-size:16px}
    .sub{color:var(--muted); font-size:12px}
    .grid{
      display:grid; gap:12px;
      grid-template-columns: repeat(12, 1fr);
    }
    .card{
      background: linear-gradient(180deg, rgba(15,31,58,.85), rgba(12,22,41,.85));
      border:1px solid rgba(148,163,184,.14);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding:14px;
      overflow:hidden;
    }
    .kpi{
      display:flex; gap:12px; align-items:flex-start;
    }
    .kpi .dot{
      width:38px;height:38px;border-radius:14px;
      background:rgba(148,163,184,.10);
      border:1px solid rgba(148,163,184,.14);
      display:grid;place-items:center;
      font-weight:900;
    }
    .kpi h3{margin:0;font-size:12px;color:rgba(229,231,235,.85)}
    .kpi .val{margin-top:6px; font-size:18px; font-weight:900; letter-spacing:.2px}
    .kpi .mini{margin-top:4px; color:var(--muted); font-size:12px}
    .kpi.good .dot{background:rgba(34,197,94,.16); border-color:rgba(34,197,94,.25)}
    .kpi.good .val{color:#b7f7c9}
    .kpi.blue .dot{background:rgba(59,130,246,.16); border-color:rgba(59,130,246,.25)}
    .kpi.blue .val{color:#bfdbfe}
    .kpi.warn .dot{background:rgba(245,158,11,.16); border-color:rgba(245,158,11,.25)}
    .kpi.warn .val{color:#fde68a}
    .kpi.bad .dot{background:rgba(239,68,68,.16); border-color:rgba(239,68,68,.25)}
    .kpi.bad .val{color:#fecaca}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .field{
      display:flex; flex-direction:column; gap:6px; flex:1;
      min-width:180px;
    }
    label{font-size:12px; color:rgba(229,231,235,.8)}
    input, select, textarea{
      width:100%;
      background:rgba(2,6,23,.55);
      border:1px solid rgba(148,163,184,.18);
      color:var(--text);
      border-radius:14px;
      padding:10px 11px;
      outline:none;
    }
    textarea{min-height:82px; resize:vertical}
    input:focus, select:focus, textarea:focus{border-color:rgba(59,130,246,.45)}
    .muted{color:var(--muted); font-size:12px}
    .hr{height:1px; background:var(--line); margin:12px 0}
    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(2,6,23,.35);
    }
    .table th,.table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(148,163,184,.10);
      font-size:13px;
      text-align:left;
      vertical-align:top;
    }
    .table th{color:rgba(229,231,235,.86); font-size:12px; letter-spacing:.2px; background:rgba(148,163,184,.06)}
    .table tr:last-child td{border-bottom:none}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px; padding:4px 8px; border-radius:999px;
      border:1px solid rgba(148,163,184,.16);
      background:rgba(148,163,184,.08);
      color:rgba(229,231,235,.9);
      white-space:nowrap;
    }
    .tag.good{border-color:rgba(34,197,94,.25); background:rgba(34,197,94,.12)}
    .tag.bad{border-color:rgba(239,68,68,.25); background:rgba(239,68,68,.12)}
    .tag.warn{border-color:rgba(245,158,11,.25); background:rgba(245,158,11,.12)}
    .right{text-align:right}
    .mono{font-family:var(--mono)}
    .split{
      display:grid; gap:12px;
      grid-template-columns: 1.2fr .8fr;
    }

    /* Mobile navigation */
    .bottomNav{
      position:fixed;
      left:12px; right:12px; bottom:12px;
      display:none;
      gap:10px;
      padding:10px;
      border-radius:18px;
      background:rgba(2,6,23,.78);
      border:1px solid rgba(148,163,184,.18);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      z-index:50;
    }
    .bottomNav button{
      all:unset;
      cursor:pointer;
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      padding:8px 6px;
      border-radius:14px;
      border:1px solid transparent;
      background:rgba(148,163,184,.06);
      color:rgba(229,231,235,.92);
      font-weight:800;
      font-size:14px;
      user-select:none;
    }
    .bottomNav button span{
      font-size:11px;
      color:rgba(229,231,235,.75);
      font-weight:700;
    }
    .bottomNav button.active{
      background:rgba(59,130,246,.16);
      border-color:rgba(59,130,246,.28);
    }
    @media (max-width: 1060px){
      .main{padding-bottom:92px;}
      .bottomNav{display:flex;}
    }
    @media (max-width: 520px){
      .btn{padding:12px 14px;border-radius:16px}
      input,select,textarea{padding:12px 12px;border-radius:16px}
    }

    @media (max-width: 1060px){
      .sidebar{display:none}
      .split{grid-template-columns:1fr}
    }
    .hide{display:none !important}

    /* Login */
    .loginWrap{
      min-height:100vh;
      display:grid; place-items:center;
      padding:20px;
    }
    .loginCard{
      width:min(520px, 100%);
      background: linear-gradient(180deg, rgba(15,31,58,.90), rgba(12,22,41,.92));
      border:1px solid rgba(148,163,184,.16);
      border-radius:24px;
      box-shadow: var(--shadow);
      padding:16px;
    }
    .loginHead{
      display:flex; align-items:center; gap:12px; padding:10px 6px 14px;
      border-bottom:1px solid var(--line);
      margin-bottom:12px;
    }
    .loginHead h2{margin:0;font-size:16px}
    .small{font-size:12px;color:var(--muted); margin:4px 0 0}
    .toast{
      position:fixed; right:16px; bottom:16px;
      background:rgba(2,6,23,.85);
      border:1px solid rgba(148,163,184,.18);
      border-radius:16px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      display:none;
      max-width:min(420px, calc(100vw - 32px));
      z-index:9999;
    }
    .toast b{display:block; font-size:13px}
    .toast span{display:block; margin-top:2px; color:var(--muted); font-size:12px}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<!-- LOGIN -->
<section id="loginView" class="loginWrap">
  <div class="loginCard">
    <div class="loginHead">
      <div class="logo">CA</div>
      <div>
        <h2>Financeiro Academia</h2>
        <div class="small">Online + Sincronizado (Supabase) ‚Ä¢ Admin/Funcion√°rio</div>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>Email</label>
        <input id="loginEmail" placeholder="seuemail@exemplo.com" autocomplete="username"/>
      </div>
      <div class="field">
        <label>Senha</label>
        <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn blue" id="btnLogin" style="flex:1">Entrar</button>
      <button class="btn" id="btnShowSignup">Criar conta</button>
    </div>

    <div class="hr"></div>

    <div id="signupBox" class="hide">
      <div style="font-weight:900">Criar conta (funcion√°rio ou admin)</div>
      <div class="muted">Depois o admin pode ativar/desativar e definir cargo.</div>
      <div class="row" style="margin-top:10px">
        <div class="field">
          <label>Nome</label>
          <input id="signupName" placeholder="Ex: Jo√£o Atendente" autocomplete="name"/>
        </div>
        <div class="field">
          <label>Email</label>
          <input id="signupEmail" placeholder="email@exemplo.com" autocomplete="email"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="field">
          <label>Senha</label>
          <input id="signupPass" type="password" placeholder="m√≠nimo 6 caracteres" autocomplete="new-password"/>
        </div>
        <button class="btn primary" id="btnSignup" style="align-self:flex-end">Criar</button>
      </div>
      <p class="muted" style="margin:10px 4px 0">
        Se o projeto exigir confirma√ß√£o por email, verifique sua caixa de entrada.
      </p>
    </div>

    <p class="muted" style="margin:12px 4px 0">
      ‚öôÔ∏è Antes de usar: cole suas chaves do Supabase no c√≥digo (SUPABASE_URL e SUPABASE_ANON_KEY).
    </p>
  </div>
</section>

<!-- APP -->
<section id="appView" class="app hide">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">CA</div>
      <div>
        <h1>Controle de Caixa ‚Ä¢ Academia</h1>
        <p id="gymNameSide">Financeiro Completo</p>
      </div>
    </div>

    <div class="nav">
      <button data-tab="dashboard" class="active">üìä Dashboard</button>
      <button data-tab="mov">üíº Movimenta√ß√µes</button>
      <button data-tab="members">üë• Alunos <span id="lateBadge" class="badge hide">0 atrasados</span></button>
      <button data-tab="reports">üßæ Relat√≥rios</button>
      <button data-tab="users" id="navUsers">üë§ Usu√°rios</button>
      <button data-tab="settings" id="navSettings">‚öôÔ∏è Configura√ß√µes</button>
    </div>

    <div class="foot">
      <span class="pill" id="cashStatusPill">Caixa: ‚Äî</span>
      <button class="btn danger" id="btnLogout">Sair</button>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="left">
        <h2 id="pageTitle">Dashboard</h2>
        <span class="pill" id="todayPill">‚Äî</span>
      </div>
      <div class="row">
        <button class="btn primary" id="btnOpenCash">Abrir Caixa</button>
        <button class="btn warn" id="btnCloseCash">Fechar Caixa</button>
        <button class="btn blue" id="btnExportCSV">Exportar CSV</button>
        <button class="btn warn" id="btnCloseDayPDF">Fechar dia (PDF)</button>
        <button class="btn" id="btnBackup">Backup</button>
      </div>
    </div>

    <!-- DASHBOARD -->
    <section id="tab-dashboard">
      <div class="grid">
        <div class="card" style="grid-column:span 3">
          <div class="kpi blue">
            <div class="dot">R$</div>
            <div>
              <h3>Entradas (per√≠odo)</h3>
              <div class="val" id="kpiIn">R$ 0,00</div>
              <div class="mini" id="kpiInMini">‚Äî</div>
            </div>
          </div>
        </div>
        <div class="card" style="grid-column:span 3">
          <div class="kpi bad">
            <div class="dot">‚Üò</div>
            <div>
              <h3>Sa√≠das (per√≠odo)</h3>
              <div class="val" id="kpiOut">R$ 0,00</div>
              <div class="mini" id="kpiOutMini">‚Äî</div>
            </div>
          </div>
        </div>
        <div class="card" style="grid-column:span 3">
          <div class="kpi good">
            <div class="dot">Œ£</div>
            <div>
              <h3>Saldo (per√≠odo)</h3>
              <div class="val" id="kpiBal">R$ 0,00</div>
              <div class="mini" id="kpiBalMini">‚Äî</div>
            </div>
          </div>
        </div>
        <div class="card" style="grid-column:span 3">
          <div class="kpi warn">
            <div class="dot">‚è∞</div>
            <div>
              <h3>Alunos em atraso</h3>
              <div class="val" id="kpiLate">0</div>
              <div class="mini">vencimento antes de hoje</div>
            </div>
          </div>
        </div>

        <div class="card" style="grid-column:span 8">
          <div class="row" style="justify-content:space-between; align-items:flex-end">
            <div>
              <div style="font-weight:900">Resumo Financeiro</div>
              <div class="muted">Filtro r√°pido para KPI e relat√≥rios</div>
            </div>
            <div class="row">
              <div class="field" style="min-width:160px">
                <label>Per√≠odo</label>
                <select id="dashRange">
                  <option value="today">Hoje</option>
                  <option value="7">√öltimos 7 dias</option>
                  <option value="30" selected>√öltimos 30 dias</option>
                  <option value="month">Este m√™s</option>
                  <option value="all">Tudo</option>
                </select>
              </div>
              <div class="field" style="min-width:160px">
                <label>Tipo</label>
                <select id="dashType">
                  <option value="all" selected>Entradas + Sa√≠das</option>
                  <option value="income">Somente Entradas</option>
                  <option value="expense">Somente Sa√≠das</option>
                </select>
              </div>
            </div>
          </div>
          <div class="hr"></div>

          <div class="split">
            <div>
              <div class="muted">Top categorias (per√≠odo)</div>
              <table class="table" style="margin-top:10px">
                <thead>
                  <tr>
                    <th>Categoria</th>
                    <th>Tipo</th>
                    <th class="right">Total</th>
                  </tr>
                </thead>
                <tbody id="topCatsBody"></tbody>
              </table>
            </div>
            <div>
              <div class="muted">M√©todos (per√≠odo)</div>
              <table class="table" style="margin-top:10px">
                <thead>
                  <tr>
                    <th>M√©todo</th>
                    <th class="right">Total</th>
                  </tr>
                </thead>
                <tbody id="payMethodsBody"></tbody>
              </table>

              <div class="hr"></div>
              <div class="muted">Status do caixa</div>
              <div style="margin-top:8px" class="row">
                <span class="tag" id="cashTag">‚Äî</span>
                <span class="pill mono" id="cashOpenedAt">‚Äî</span>
              </div>
              <div class="muted" style="margin-top:10px" id="cashHint">
                Abra o caixa para registrar movimenta√ß√µes do dia.
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="grid-column:span 4">
          <div style="font-weight:900">√öltimas movimenta√ß√µes</div>
          <div class="muted">Entradas e sa√≠das recentes</div>
          <div class="hr"></div>
          <div style="max-height:360px; overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Descri√ß√£o</th>
                  <th class="right">Valor</th>
                </tr>
              </thead>
              <tbody id="lastMovesBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- MOVIMENTA√á√ïES -->
    <section id="tab-mov" class="hide">
      <div class="grid">
        <div class="card" style="grid-column:span 12">
          <div class="row" style="justify-content:space-between; align-items:flex-end">
            <div>
              <div style="font-weight:900">Registrar movimenta√ß√£o</div>
              <div class="muted">Entradas (mensalidade, di√°ria, produto) e sa√≠das (despesas)</div>
            </div>
            <span class="tag" id="cashTag2">‚Äî</span>
          </div>
          <div class="hr"></div>

          <div class="row">
            <div class="field">
              <label>Tipo</label>
              <select id="movType">
                <option value="income" selected>Entrada</option>
                <option value="expense">Sa√≠da</option>
              </select>
            </div>

            <div class="field">
              <label>Categoria</label>
              <select id="movCat">
                <option>Mensalidade</option>
                <option>Di√°ria</option>
                <option>Produto</option>
                <option>Personal</option>
                <option>Outros</option>
                <option>Aluguel</option>
                <option>√Ågua/Luz</option>
                <option>Manuten√ß√£o</option>
                <option>Fornecedor</option>
                <option>Internet</option>
                <option>Sal√°rios</option>
              </select>
            </div>

            <div class="field">
              <label>Valor (R$)</label>
              <input id="movAmount" type="number" step="0.01" placeholder="Ex: 120.00"/>
            </div>

            <div class="field">
              <label>Data</label>
              <input id="movDate" type="date"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>M√©todo de pagamento</label>
              <select id="movPay">
                <option>Dinheiro</option>
                <option>PIX</option>
                <option>Cart√£o D√©bito</option>
                <option>Cart√£o Cr√©dito</option>
                <option>Transfer√™ncia</option>
              </select>
            </div>

            <div class="field">
              <label>Aluno (opcional)</label>
              <select id="movMember">
                <option value="">‚Äî</option>
              </select>
            </div>

            <div class="field" style="min-width:280px">
              <label>Descri√ß√£o</label>
              <input id="movDesc" placeholder="Ex: Mensalidade Janeiro / Compra de material"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field" style="min-width:280px">
              <label>Observa√ß√£o (opcional)</label>
              <input id="movNote" placeholder="Ex: Nota fiscal 123"/>
            </div>
            <div class="field">
              <label>Funcion√°rio</label>
              <input id="movStaff" placeholder="Autom√°tico" readonly/>
            </div>
            <div style="display:flex; gap:10px; align-items:flex-end">
              <button class="btn blue" id="btnAddMov">Salvar</button>
              <button class="btn danger" id="btnClearMov">Limpar</button>
            </div>
          </div>

          <div class="muted" style="margin-top:10px" id="cashLockMsg"></div>
        </div>

        <div class="card" style="grid-column:span 12">
          <div class="row" style="justify-content:space-between; align-items:flex-end">
            <div>
              <div style="font-weight:900">Movimenta√ß√µes</div>
              <div class="muted">Filtre por per√≠odo, tipo, aluno e texto</div>
            </div>
            <div class="row">
              <div class="field" style="min-width:150px">
                <label>De</label>
                <input id="fFrom" type="date"/>
              </div>
              <div class="field" style="min-width:150px">
                <label>At√©</label>
                <input id="fTo" type="date"/>
              </div>
              <div class="field" style="min-width:170px">
                <label>Tipo</label>
                <select id="fType">
                  <option value="all">Todos</option>
                  <option value="income">Entradas</option>
                  <option value="expense">Sa√≠das</option>
                </select>
              </div>
              <div class="field" style="min-width:200px">
                <label>Aluno</label>
                <select id="fMember"><option value="">Todos</option></select>
              </div>
              <div class="field" style="min-width:240px">
                <label>Buscar</label>
                <input id="fSearch" placeholder="descri√ß√£o, categoria, funcion√°rio..."/>
              </div>
              <button class="btn" id="btnApplyFilter" style="align-self:flex-end">Aplicar</button>
            </div>
          </div>

          <div class="hr"></div>

          <div style="overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Tipo</th>
                  <th>Categoria</th>
                  <th>Descri√ß√£o</th>
                  <th>Aluno</th>
                  <th>M√©todo</th>
                  <th>Funcion√°rio</th>
                  <th class="right">Valor</th>
                  <th class="right">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="movTableBody"></tbody>
            </table>
          </div>

          <div class="row" style="justify-content:space-between; margin-top:10px">
            <div class="muted" id="movCount">‚Äî</div>
            <div class="row">
              <span class="tag good" id="movSumIn">Entradas: R$ 0,00</span>
              <span class="tag bad" id="movSumOut">Sa√≠das: R$ 0,00</span>
              <span class="tag" id="movSumBal">Saldo: R$ 0,00</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ALUNOS -->
    <section id="tab-members" class="hide">
      <div class="grid">
        <div class="card" style="grid-column:span 12">
          <div class="row" style="justify-content:space-between; align-items:flex-end">
            <div>
              <div style="font-weight:900">Cadastro de alunos</div>
              <div class="muted">Controle de vencimento + atrasos + hist√≥rico individual</div>
            </div>
            <button class="btn blue" id="btnAddMember">Adicionar aluno</button>
          </div>
          <div class="hr"></div>

          <div class="row">
            <div class="field" style="min-width:260px">
              <label>Buscar aluno</label>
              <input id="mSearch" placeholder="nome, telefone, plano..."/>
            </div>

            <div class="field" style="min-width:240px">
              <label>Chave PIX (para cobran√ßa)</label>
              <input id="setPixKey" placeholder="Ex: 79999991111 ou email@pix.com"/>
            </div>
            <div class="field" style="min-width:320px">
              <label>Mensagem WhatsApp (modelo)</label>
              <input id="setWaTpl" placeholder="Ol√° {nome}, sua mensalidade venceu em {vencimento}. PIX: {pix} ‚Ä¢ {academia}"/>
            </div>

            <div class="field" style="min-width:200px">
              <label>Status</label>
              <select id="mStatus">
                <option value="all">Todos</option>
                <option value="ok">Em dia</option>
                <option value="late">Atrasados</option>
              </select>
            </div>
          </div>

          <div class="hr"></div>

          <div style="overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Aluno</th>
                  <th>Plano</th>
                  <th>Vencimento</th>
                  <th>Status</th>
                  <th>Contato</th>
                  <th class="right">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="membersBody"></tbody>
            </table>
          </div>
        </div>

        <div class="card" style="grid-column:span 12">
          <div class="row" style="justify-content:space-between; align-items:flex-end">
            <div>
              <div style="font-weight:900">Hist√≥rico individual</div>
              <div class="muted">Selecione um aluno para ver entradas relacionadas</div>
            </div>
            <div class="row">
              <div class="field" style="min-width:260px">
                <label>Aluno</label>
                <select id="histMember"><option value="">‚Äî</option></select>
              </div>
              <button class="btn" id="btnHistLoad" style="align-self:flex-end">Carregar</button>
            </div>
          </div>
          <div class="hr"></div>

          <div style="overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Categoria</th>
                  <th>Descri√ß√£o</th>
                  <th>M√©todo</th>
                  <th class="right">Valor</th>
                </tr>
              </thead>
              <tbody id="histBody"></tbody>
            </table>
          </div>
          <div class="row" style="justify-content:space-between; margin-top:10px">
            <div class="muted" id="histCount">‚Äî</div>
            <span class="tag good" id="histSum">Total: R$ 0,00</span>
          </div>
        </div>
      </div>
    </section>

    <!-- RELAT√ìRIOS -->
    <section id="tab-reports" class="hide">
      <div class="grid">
        <div class="card" style="grid-column:span 12">
          <div style="font-weight:900">Relat√≥rios</div>
          <div class="muted">Gere um resumo por per√≠odo e exporte CSV (ou imprima pelo navegador)</div>
          <div class="hr"></div>

          <div class="row">
            <div class="field" style="min-width:160px">
              <label>De</label>
              <input id="rFrom" type="date"/>
            </div>
            <div class="field" style="min-width:160px">
              <label>At√©</label>
              <input id="rTo" type="date"/>
            </div>
            <div class="field" style="min-width:190px">
              <label>Agrupar por</label>
              <select id="rGroup">
                <option value="day">Dia</option>
                <option value="cat" selected>Categoria</option>
                <option value="pay">M√©todo</option>
                <option value="staff">Funcion√°rio</option>
              </select>
            </div>
            <div class="field" style="min-width:190px">
              <label>Tipo</label>
              <select id="rType">
                <option value="all" selected>Entradas + Sa√≠das</option>
                <option value="income">Entradas</option>
                <option value="expense">Sa√≠das</option>
              </select>
            </div>
            <button class="btn blue" id="btnBuildReport" style="align-self:flex-end">Gerar</button>
            <button class="btn" id="btnPrint" style="align-self:flex-end">Imprimir</button>
          </div>

          <div class="hr"></div>

          <div class="row" style="justify-content:space-between">
            <div class="row">
              <span class="tag good" id="rSumIn">Entradas: R$ 0,00</span>
              <span class="tag bad" id="rSumOut">Sa√≠das: R$ 0,00</span>
              <span class="tag" id="rSumBal">Saldo: R$ 0,00</span>
            </div>
            <div class="muted" id="rCount">‚Äî</div>
          </div>

          <div style="overflow:auto; margin-top:10px">
            <table class="table">
              <thead>
                <tr>
                  <th>Grupo</th>
                  <th>Tipo</th>
                  <th class="right">Total</th>
                  <th class="right">Qtde</th>
                </tr>
              </thead>
              <tbody id="reportBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- USU√ÅRIOS (ADMIN) -->
    <section id="tab-users" class="hide">
      <div class="grid">
        <div class="card" style="grid-column:span 12">
          <div style="font-weight:900">Usu√°rios</div>
          <div class="muted">Apenas admin v√™ esta aba. Aqui voc√™ ativa/desativa e define Admin/Funcion√°rio.</div>
          <div class="hr"></div>
          <div style="overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Email</th>
                  <th>Cargo</th>
                  <th>Status</th>
                  <th class="right">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="usersBody"></tbody>
            </table>
          </div>
          <div class="muted" style="margin-top:10px">
            Nota: cria√ß√£o de conta √© feita na tela de login (Criar conta). Depois o admin ajusta cargo/status aqui.
          </div>
        </div>
      </div>
    </section>

    <!-- CONFIG -->
    <section id="tab-settings" class="hide">
      <div class="grid">
        <div class="card" style="grid-column:span 12">
          <div style="font-weight:900">Configura√ß√µes</div>
          <div class="muted">Somente admin pode ver e alterar (local).</div>
          <div class="hr"></div>

          <div class="row">
            <div class="field" style="min-width:240px">
              <label>Nome da academia (local)</label>
              <input id="setGymName" placeholder="Ex: Academia Alpha"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn blue" id="btnSaveSettings">Salvar</button>
          </div>

          
          <div class="hr"></div>
          <div style="font-weight:900">Backup</div>
          <div class="muted">Exportar/Importar dados (JSON). √ötil para c√≥pia de seguran√ßa.</div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnBackupExport">Exportar Backup (JSON)</button>
            <label class="btn" style="display:inline-flex; align-items:center; gap:10px; cursor:pointer">
              Importar Backup (JSON)
              <input id="backupFile" type="file" accept="application/json" style="display:none"/>
            </label>
          </div>
          <div class="muted" style="margin-top:8px">
            Importar faz <b>upsert</b> (atualiza/insere). Recomendado s√≥ para admin.
          </div>

          <div class="hr"></div>
          <div class="muted">
            Dica: para gerar PDF, use o bot√£o <b>Imprimir</b> no relat√≥rio e selecione ‚ÄúSalvar como PDF‚Äù.
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- MOBILE NAV -->
  <nav class="bottomNav">
    <button data-tab="dashboard">üè†<span>In√≠cio</span></button>
    <button data-tab="mov">üíº<span>Mov.</span></button>
    <button data-tab="members">üë•<span>Alunos</span></button>
    <button data-tab="reports">üßæ<span>Relat.</span></button>
    <button data-tab="settings">‚öôÔ∏è<span>Config</span></button>
  </nav>

</section>

<div class="toast" id="toast"></div>

<!-- Supabase JS (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* =============================
   SUPABASE CONFIG
============================= */
// ‚úÖ COLE AQUI OS DADOS DO SEU PROJETO SUPABASE (Settings > API)
const SUPABASE_URL = "https://ziycokukjwwhmysgrzkw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_PKK4x2cntWfeU-OIIAf9mQ_GFQKSUT0";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =============================
   HELPERS
============================= */
function moneyBR(v){
  const n = Number(v || 0);
  return n.toLocaleString("pt-BR", {style:"currency", currency:"BRL"});
}
function isoToday(){
  const d = new Date();
  const off = d.getTimezoneOffset();
  const local = new Date(d.getTime() - off*60000);
  return local.toISOString().slice(0,10);
}
function parseISO(s){
  if(!s) return null;
  const [y,m,d] = s.split("-").map(Number);
  return new Date(y, m-1, d);
}
function fmtDateBR(iso){
  if(!iso) return "‚Äî";
  const d = parseISO(iso);
  return d ? d.toLocaleDateString("pt-BR") : iso;
}

function digitsOnly(s){ return String(s||"").replace(/\D+/g,""); }
function normalizePhoneToWA(phone){
  // aceita (79) 99999-1111 ou 079999991111 ou +55...
  const d = digitsOnly(phone);
  if(!d) return "";
  // se j√° tiver 55 + DDD + n√∫mero (>=12), usa como est√°
  if(d.startsWith("55") && d.length >= 12) return d;
  // se tiver DDD+numero (10 ou 11), adiciona 55
  if(d.length === 10 || d.length === 11) return "55" + d;
  // fallback
  return d;
}
function waMessage(tpl, member){
  const acad = DB.settings.gymName || "Academia";
  const pix = DB.settings.pixKey || "‚Äî";
  return (tpl||"").replaceAll("{nome}", member?.name||"")
                  .replaceAll("{vencimento}", fmtDateBR(member?.due)||"‚Äî")
                  .replaceAll("{academia}", acad)
                  .replaceAll("{pix}", pix);
}

function toast(title, msg){
  const t = document.getElementById("toast");
  t.innerHTML = `<b>${title}</b><span>${msg || ""}</span>`;
  t.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=> t.style.display="none", 3200);
}
function shiftISO(iso, days){
  const dt = parseISO(iso);
  dt.setDate(dt.getDate() + days);
  const off = dt.getTimezoneOffset();
  const local = new Date(dt.getTime() - off*60000);
  return local.toISOString().slice(0,10);
}
function inRange(iso, fromISO, toISO){
  if(!iso) return false;
  const x = parseISO(iso).getTime();
  if(fromISO){
    const a = parseISO(fromISO).getTime();
    if(x < a) return false;
  }
  if(toISO){
    const b = parseISO(toISO).getTime();
    const end = b + 24*60*60*1000 - 1;
    if(x > end) return false;
  }
  return true;
}

/* =============================
   STATE (SINCRONIZADO)
============================= */
let DB = {
  settings: { gymName: "Financeiro Completo", pixKey: "", waTpl: "Ol√° {nome}, sua mensalidade venceu em {vencimento}. PIX: {pix} ‚Ä¢ {academia}" }, // local
  profile: null, // {id,name,role,active,email}
  cash: { isOpen:false, openedAt:null, closedAt:null, openedBy:null, closedBy:null },
  members: [],
  moves: [],
  users: [] // profiles (admin)
};

const loginView = document.getElementById("loginView");
const appView = document.getElementById("appView");

const todayPill = document.getElementById("todayPill");
todayPill.textContent = `Hoje: ${fmtDateBR(isoToday())}`;

document.getElementById("movDate").value = isoToday();
document.getElementById("fFrom").value = shiftISO(isoToday(), -30);
document.getElementById("fTo").value = isoToday();
document.getElementById("rFrom").value = shiftISO(isoToday(), -30);
document.getElementById("rTo").value = isoToday();

/* =============================
   AUTH (SUPABASE)
============================= */
function isAdmin(){
  return DB.profile && DB.profile.role === "admin" && DB.profile.active === true;
}
function currentUserName(){
  return (DB.profile && DB.profile.name) ? DB.profile.name : "‚Äî";
}
function currentUserId(){
  return DB.profile ? DB.profile.id : null;
}

async function ensureProfile(user){
  if(!user) return null;

  // tenta ler
  const { data: rows, error } = await sb.from("profiles").select("*").eq("id", user.id).limit(1);
  if(error) throw error;

  if(rows && rows.length){
    const p = rows[0];
    return { ...p, email: user.email };
  }

  // cria perfil padr√£o
  const ins = {
    id: user.id,
    name: (user.user_metadata && user.user_metadata.name) ? user.user_metadata.name : (user.email || ""),
    role: "staff",
    active: true
  };
  const { error: err2 } = await sb.from("profiles").insert(ins);
  if(err2) throw err2;

  const { data: rows2, error: err3 } = await sb.from("profiles").select("*").eq("id", user.id).limit(1);
  if(err3) throw err3;

  const p = rows2[0];
  return { ...p, email: user.email };
}

async function loadAll(){
  // caixa
  const { data: cashRows, error: cashErr } = await sb.from("cash_sessions").select("*").limit(1);
  if(cashErr) throw cashErr;
  if(cashRows && cashRows.length){
    const c = cashRows[0];
    DB.cash = {
      isOpen: !!c.is_open,
      openedAt: c.opened_at,
      closedAt: c.closed_at,
      openedBy: c.opened_by,
      closedBy: c.closed_by
    };
  }

  // alunos
  const { data: members, error: memErr } = await sb.from("members").select("*").order("name", {ascending:true});
  if(memErr) throw memErr;
  DB.members = (members || []).map(m => ({
    id: m.id,
    name: m.name,
    phone: m.phone || "",
    plan: m.plan || "Mensal",
    due: m.due,
    notes: m.notes || ""
  }));

  // moves
  const { data: moves, error: movErr } = await sb.from("moves").select("*").order("created_at", {ascending:false});
  if(movErr) throw movErr;
  DB.moves = (moves || []).map(m => ({
    id: m.id,
    type: m.type,
    cat: m.cat,
    amount: Number(m.amount),
    date: m.date,
    pay: m.pay,
    memberId: m.member_id,
    desc: m.description,
    note: m.note || "",
    staff: m.staff_name || "‚Äî",
    staffUserId: m.staff_user_id || null
  }));

  // users list (admin only)
  if(isAdmin()){
    const { data: users, error: uerr } = await sb.from("profiles").select("*").order("created_at", {ascending:false});
    if(uerr) throw uerr;
    // precisa do email: n√£o vem do profiles. Guardamos somente name/role/active/id e mostramos email como "‚Äî"
    DB.users = (users || []).map(u => ({...u, email: "‚Äî"}));
  } else {
    DB.users = [];
  }

  renderAll();
}

function renderAuth(logged){
  loginView.classList.toggle("hide", !!logged);
  appView.classList.toggle("hide", !logged);
  if(logged) renderAll();
}

document.getElementById("btnShowSignup").addEventListener("click", ()=>{
  document.getElementById("signupBox").classList.toggle("hide");
});

document.getElementById("btnSignup").addEventListener("click", async ()=>{
  try{
    const name = document.getElementById("signupName").value.trim();
    const email = document.getElementById("signupEmail").value.trim();
    const pass = document.getElementById("signupPass").value;
    if(!name || !email || !pass) return toast("Erro", "Preencha nome, email e senha.");

    const { data, error } = await sb.auth.signUp({
      email,
      password: pass,
      options: { data: { name } }
    });
    if(error) throw error;

    toast("Conta criada", "Agora fa√ßa login. (Se pedir confirma√ß√£o, confirme no email.)");
    document.getElementById("signupBox").classList.add("hide");
  }catch(e){
    toast("Erro", e.message || String(e));
  }
});

document.getElementById("btnLogin").addEventListener("click", async ()=>{
  try{
    const email = document.getElementById("loginEmail").value.trim();
    const pass = document.getElementById("loginPass").value;
    if(!email || !pass) return toast("Erro", "Informe email e senha.");

    const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
    if(error) throw error;

    const user = data.user;
    DB.profile = await ensureProfile(user);

    if(DB.profile.active !== true){
      await sb.auth.signOut();
      DB.profile = null;
      renderAuth(false);
      return toast("Acesso bloqueado", "Seu usu√°rio est√° inativo. Fale com o admin.");
    }

    toast("Bem-vindo!", `Logado como ${DB.profile.name} (${DB.profile.role === "admin" ? "Admin" : "Funcion√°rio"})`);
    renderAuth(true);
    await loadAll();
  }catch(e){
    toast("Login inv√°lido", e.message || String(e));
  }
});

document.getElementById("btnLogout").addEventListener("click", async ()=>{
  await sb.auth.signOut();
  DB.profile = null;
  toast("Saiu", "Sess√£o encerrada.");
  renderAuth(false);
});

/* =============================
   NAV TABS
============================= */
const tabs = ["dashboard","mov","members","reports","users","settings"];
document.querySelectorAll(".nav button").forEach(btn=>{
  btn.addEventListener("click", ()=> setTab(btn.dataset.tab));
});
// mobile nav
document.querySelectorAll(".bottomNav button").forEach(btn=>{
  btn.addEventListener("click", ()=> setTab(btn.dataset.tab));
});
function setTab(tab){
  document.querySelectorAll(".nav button").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
  document.querySelectorAll(".bottomNav button").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
  tabs.forEach(t=>{
    const el = document.getElementById("tab-"+t);
    if(el) el.classList.toggle("hide", t!==tab);
  });
  const titles = {
    dashboard:"Dashboard",
    mov:"Movimenta√ß√µes",
    members:"Alunos",
    reports:"Relat√≥rios",
    users:"Usu√°rios",
    settings:"Configura√ß√µes",
  };
  document.getElementById("pageTitle").textContent = titles[tab] || "‚Äî";
  renderAll();
}

/* =============================
   CASH OPEN/CLOSE (SYNC)
============================= */
function cashStatusText(){
  return DB.cash.isOpen ? "ABERTO" : "FECHADO";
}
document.getElementById("btnOpenCash").addEventListener("click", async ()=>{
  try{
    if(DB.cash.isOpen){ toast("Caixa j√° est√° aberto", ""); return; }
    const staff = currentUserName();
    const payload = {
      is_open: true,
      opened_at: new Date().toISOString(),
      opened_by: staff,
      closed_at: null,
      closed_by: null
    };
    const { error } = await sb.from("cash_sessions").update(payload);
    if(error) throw error;
    toast("Caixa aberto", `Respons√°vel: ${staff}`);
    await loadAll();
  }catch(e){
    toast("Erro", e.message || String(e));
  }
});
document.getElementById("btnCloseCash").addEventListener("click", async ()=>{
  try{
    if(!DB.cash.isOpen){ toast("Caixa j√° est√° fechado", ""); return; }
    const staff = currentUserName();
    const payload = {
      is_open: false,
      closed_at: new Date().toISOString(),
      closed_by: staff
    };
    const { error } = await sb.from("cash_sessions").update(payload);
    if(error) throw error;
    toast("Caixa fechado", `Respons√°vel: ${staff}`);
    await loadAll();
  }catch(e){
    toast("Erro", e.message || String(e));
  }

// Fechamento do dia (PDF) + opcional fechar caixa
document.getElementById("btnCloseDayPDF").addEventListener("click", async ()=>{
  try{
    const day = prompt("Fechamento de qual dia? (AAAA-MM-DD)", isoToday())?.trim();
    if(!day) return;

    // gera PDF
    await generateCloseDayPDF(day);

    // se caixa estiver aberto, pergunta se deseja fechar tamb√©m
    if(DB.cash.isOpen){
      const ok = confirm("Deseja tamb√©m FECHAR o caixa agora?");
      if(ok){
        const staff = currentUserName();
        const payload = { is_open:false, closed_at: new Date().toISOString(), closed_by: staff };
        const { error } = await sb.from("cash_sessions").update(payload);
        if(error) throw error;
        toast("Caixa fechado", `Respons√°vel: ${staff}`);
        await loadAll();
      }
    }
  }catch(e){
    toast("Erro", e.message || String(e));
  }
});
document.getElementById("btnBackup").addEventListener("click", ()=>{
  setTab("settings");
  const el = document.getElementById("btnBackupExport");
  if(el) el.scrollIntoView({behavior:"smooth", block:"center"});
});

});

/* =============================
   MOVIMENTA√á√ïES (SYNC CRUD)
============================= */
document.getElementById("btnAddMov").addEventListener("click", async ()=>{
  try{
    if(!DB.cash.isOpen){
      toast("Caixa fechado", "Abra o caixa para registrar movimenta√ß√µes.");
      return;
    }

    const type = document.getElementById("movType").value;
    const cat = document.getElementById("movCat").value;
    const amount = Number(document.getElementById("movAmount").value);
    const date = document.getElementById("movDate").value;
    const pay = document.getElementById("movPay").value;
    const memberId = document.getElementById("movMember").value || null;
    const desc = document.getElementById("movDesc").value.trim();
    const note = document.getElementById("movNote").value.trim();

    if(!date){ toast("Erro", "Selecione a data."); return; }
    if(!amount || amount <= 0){ toast("Erro", "Informe um valor v√°lido."); return; }
    if(!desc){ toast("Erro", "Informe a descri√ß√£o."); return; }

    const staff = currentUserName();
    const staffUserId = currentUserId();

    const ins = {
      type,
      cat,
      amount,
      date,
      pay,
      member_id: memberId,
      description: desc,
      note,
      staff_name: staff,
      staff_user_id: staffUserId
    };

    const { error } = await sb.from("moves").insert(ins);
    if(error) throw error;

    // ‚úÖ renovar vencimento se for mensalidade e tiver aluno selecionado
    if(type === "income" && memberId && (cat || "").trim().toLowerCase().includes("mensal")){
      const base = parseISO(date);
      base.setMonth(base.getMonth() + 1);
      const off = base.getTimezoneOffset();
      const local = new Date(base.getTime() - off*60000);
      const newDue = local.toISOString().slice(0,10);

      const { error: err2 } = await sb.from("members").update({ due: newDue }).eq("id", memberId);
      if(err2) throw err2;

      toast("Mensalidade atualizada", `Novo vencimento: ${fmtDateBR(newDue)}`);
    } else {
      toast("Salvo", "Movimenta√ß√£o registrada.");
    }

    document.getElementById("movAmount").value = "";
    document.getElementById("movDesc").value = "";
    document.getElementById("movNote").value = "";

    await loadAll();
  }catch(e){
    toast("Erro", e.message || String(e));
  }
});
document.getElementById("btnClearMov").addEventListener("click", ()=>{
  document.getElementById("movAmount").value = "";
  document.getElementById("movDesc").value = "";
  document.getElementById("movNote").value = "";
  toast("Limpo", "Campos resetados.");
});

async function deleteMove(id){
  try{
    const { error } = await sb.from("moves").delete().eq("id", id);
    if(error) throw error;
    toast("Exclu√≠do", "Movimenta√ß√£o removida.");
    await loadAll();
  }catch(e){
    toast("Erro", e.message || String(e));
  }
}

/* =============================
   MEMBERS (SYNC CRUD)
============================= */
document.getElementById("btnAddMember").addEventListener("click", async ()=>{
  try{
    const name = prompt("Nome do aluno:")?.trim();
    if(!name) return;
    const phone = prompt("Telefone/WhatsApp (opcional):")?.trim() || "";
    const plan = prompt("Plano (ex: Mensal, Trimestral):")?.trim() || "Mensal";
    const due = prompt("Vencimento (AAAA-MM-DD):", isoToday())?.trim() || isoToday();

    const { error } = await sb.from("members").insert({ name, phone, plan, due, notes:"" });
    if(error) throw error;
    toast("Aluno adicionado", name);
    await loadAll();
  }catch(e){
    toast("Erro", e.message || String(e));
  }
});

async function editMember(id){
  try{
    const m = DB.members.find(x=>x.id===id);
    if(!m) return;
    const name = prompt("Nome:", m.name)?.trim();
    if(!name) return;
    const phone = prompt("Telefone/WhatsApp:", m.phone || "")?.trim() || "";
    const plan = prompt("Plano:", m.plan || "Mensal")?.trim() || "Mensal";
    const due = prompt("Vencimento (AAAA-MM-DD):", m.due || isoToday())?.trim() || m.due;
    const notes = prompt("Observa√ß√µes:", m.notes || "") ?? m.notes;

    const { error } = await sb.from("members").update({ name, phone, plan, due, notes }).eq("id", id);
    if(error) throw error;
    toast("Aluno atualizado", name);
    await loadAll();
  }catch(e){
    toast("Erro", e.message || String(e));
  }
}

async function deleteMember(id){
  try{
    const m = DB.members.find(x=>x.id===id);
    if(!m) return;
    if(!confirm(`Excluir aluno "${m.name}"?`)) return;

    const { error } = await sb.from("members").delete().eq("id", id);
    if(error) throw error;

    toast("Aluno exclu√≠do", m.name);
    await loadAll();
  }catch(e){
    toast("Erro", e.message || String(e));
  }
}

/* =============================
   USERS (ADMIN) - profiles
============================= */
async function renderUsers(){
  const body = document.getElementById("usersBody");
  if(!body) return;
  body.innerHTML = "";

  if(!isAdmin()){
    body.innerHTML = `<tr><td colspan="5" class="muted">Somente admin.</td></tr>`;
    return;
  }

  // Carrega listagem sempre que abrir a aba users (para refletir mudan√ßas)
  const { data: users, error } = await sb.from("profiles").select("*").order("created_at", {ascending:false});
  if(error){
    body.innerHTML = `<tr><td colspan="5" class="muted">Erro ao carregar usu√°rios.</td></tr>`;
    return;
  }

  users.forEach(u=>{
    const roleTag = u.role === "admin" ? `<span class="tag good">Admin</span>` : `<span class="tag">Funcion√°rio</span>`;
    const stTag = u.active ? `<span class="tag good">Ativo</span>` : `<span class="tag bad">Inativo</span>`;
    body.insertAdjacentHTML("beforeend", `
      <tr>
        <td><b>${u.name || "‚Äî"}</b></td>
        <td class="muted">‚Äî</td>
        <td>${roleTag}</td>
        <td>${stTag}</td>
        <td class="right">
          <button class="btn" onclick="toggleActive('${u.id}', ${u.active ? "true" : "false"})">${u.active ? "Desativar" : "Ativar"}</button>
          <button class="btn warn" onclick="toggleRole('${u.id}', '${u.role}')">Trocar cargo</button>
        </td>
      </tr>
    `);
  });

  if(users.length === 0){
    body.innerHTML = `<tr><td colspan="5" class="muted">Sem usu√°rios.</td></tr>`;
  }
}

window.toggleActive = async function(id, curActive){
  try{
    if(!isAdmin()) return toast("Acesso negado", "Somente admin.");
    // evita desativar o √∫ltimo admin ativo
    if(curActive){
      const { data: admins, error } = await sb.from("profiles").select("id").eq("role","admin").eq("active", true);
      if(error) throw error;
      if(admins.length <= 1){
        const me = currentUserId();
        if(id === me){
          return toast("Bloqueado", "Voc√™ n√£o pode desativar o √∫ltimo admin (voc√™).");
        }
      }
    }
    const { error } = await sb.from("profiles").update({ active: !curActive }).eq("id", id);
    if(error) throw error;
    toast("Atualizado", "Status atualizado.");
    await loadAll();
    await renderUsers();
  }catch(e){
    toast("Erro", e.message || String(e));
  }
}

window.toggleRole = async function(id, curRole){
  try{
    if(!isAdmin()) return toast("Acesso negado", "Somente admin.");
    const next = curRole === "admin" ? "staff" : "admin";

    // evita rebaixar o √∫ltimo admin
    if(curRole === "admin"){
      const { data: admins, error } = await sb.from("profiles").select("id").eq("role","admin").eq("active", true);
      if(error) throw error;
      if(admins.length <= 1 && admins[0]?.id === id){
        return toast("Bloqueado", "Voc√™ n√£o pode remover o cargo do √∫ltimo admin.");
      }
    }

    const { error } = await sb.from("profiles").update({ role: next }).eq("id", id);
    if(error) throw error;
    toast("Atualizado", `Cargo alterado para ${next === "admin" ? "Admin" : "Funcion√°rio"}.`);
    await loadAll();
    await renderUsers();
  }catch(e){
    toast("Erro", e.message || String(e));
  }
}
function chargeMemberWA(id){
  const m = DB.members.find(x=>x.id===id);
  if(!m){ toast("Erro","Aluno n√£o encontrado."); return; }
  if(!m.phone){ toast("Sem WhatsApp","Cadastre o telefone do aluno."); return; }
  const waPhone = normalizePhoneToWA(m.phone);
  if(!waPhone){ toast("Telefone inv√°lido","Verifique o telefone do aluno."); return; }
  const tpl = DB.settings.waTpl || "Ol√° {nome}, sua mensalidade venceu em {vencimento}. PIX: {pix} ‚Ä¢ {academia}";
  const msg = encodeURIComponent(waMessage(tpl, m));
  const url = `https://wa.me/${waPhone}?text=${msg}`;
  window.open(url, "_blank");
}



/* =============================
   EXPORT CSV (ALL MOVES)
============================= */
document.getElementById("btnExportCSV").addEventListener("click", ()=>{
  const rows = [
    ["data","tipo","categoria","descricao","aluno","metodo","funcionario","valor","observacao"],
    ...DB.moves.map(m=>{
      const mem = DB.members.find(x=>x.id===m.memberId);
      return [
        m.date,
        m.type==="income"?"entrada":"saida",
        m.cat,
        (m.desc||"").replaceAll('"','""'),
        mem?mem.name:"",
        m.pay,
        m.staff,
        String(m.amount).replace(".",","),
        (m.note||"").replaceAll('"','""'),
      ];
    })
  ];
  const csv = rows.map(r => r.map(x => `"${String(x)}"`).join(";")).join("\\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `movimentacoes_${isoToday()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast("Exportado", "CSV baixado com sucesso.");
});

/* =============================
   FILTERS + REPORTS
============================= */
document.getElementById("btnApplyFilter").addEventListener("click", renderMovesTable);
document.getElementById("btnBuildReport").addEventListener("click", renderReport);
document.getElementById("btnPrint").addEventListener("click", ()=> window.print());

/* =============================
   SETTINGS (LOCAL)
============================= */
document.getElementById("btnSaveSettings").addEventListener("click", ()=>{
  if(!isAdmin()){
    toast("Acesso negado", "Somente admin.");
    return;
  }
  const gymName = document.getElementById("setGymName").value.trim() || "Financeiro Completo";
  const pixKey = document.getElementById("setPixKey").value.trim();
  const waTpl = document.getElementById("setWaTpl").value.trim() || DB.settings.waTpl;
  DB.settings.gymName = gymName;
  DB.settings.pixKey = pixKey;
  DB.settings.waTpl = waTpl;
  localStorage.setItem("gym_name_local", gymName);
  localStorage.setItem("pix_key_local", pixKey);
  localStorage.setItem("wa_tpl_local", waTpl);
  toast("Salvo", "Configura√ß√µes atualizadas (local).");
  renderAll();
});

document.getElementById("btnBackupExport").addEventListener("click", async ()=>{
  try{
    await loadAll();
    const payload = {
      exportedAt: new Date().toISOString(),
      gymName: DB.settings.gymName || "",
      members: DB.members,
      moves: DB.moves,
      cash: DB.cash
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `backup_caixa_${isoToday()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast("Backup exportado","Arquivo JSON baixado.");
  }catch(e){
    toast("Erro", e.message || String(e));
  }
});

document.getElementById("backupFile").addEventListener("change", async (ev)=>{
  try{
    if(!isAdmin()){
      toast("Acesso negado","Somente admin pode importar backup.");
      ev.target.value = "";
      return;
    }
    const file = ev.target.files?.[0];
    if(!file) return;
    const text = await file.text();
    const data = JSON.parse(text);

    if(!confirm("Importar backup? Isso vai inserir/atualizar alunos e movimenta√ß√µes no Supabase.")){
      ev.target.value = "";
      return;
    }

    // upsert members
    if(Array.isArray(data.members) && data.members.length){
      const { error: e1 } = await sb.from("members").upsert(
        data.members.map(m=>({
          id: m.id,
          name: m.name,
          phone: m.phone || "",
          plan: m.plan || "Mensal",
          due: m.due,
          notes: m.notes || ""
        })),
        { onConflict: "id" }
      );
      if(e1) throw e1;
    }

    // upsert moves
    if(Array.isArray(data.moves) && data.moves.length){
      const { error: e2 } = await sb.from("moves").upsert(
        data.moves.map(m=>({
          id: m.id,
          type: m.type,
          cat: m.cat,
          amount: m.amount,
          date: m.date,
          pay: m.pay,
          member_id: m.memberId || null,
          description: m.desc,
          note: m.note || "",
          staff_name: m.staff || "",
          staff_user_id: m.staffUserId || null,
          created_at: m.createdAt || null
        })),
        { onConflict: "id" }
      );
      if(e2) throw e2;
    }

    toast("Importado","Backup aplicado com sucesso.");
    await loadAll();
    renderAll();
  }catch(e){
    toast("Erro ao importar", e.message || String(e));
  }finally{
    ev.target.value = "";
  }
});


/* =============================
   RENDER
============================= */
function fillMemberSelects(){
  const list = DB.members.slice().sort((a,b)=>a.name.localeCompare(b.name));
  const movMember = document.getElementById("movMember");
  const fMember = document.getElementById("fMember");
  const histMember = document.getElementById("histMember");

  const selectedMov = movMember.value;
  const selectedFilter = fMember.value;
  const selectedHist = histMember.value;

  const opt = (value, label) => {
    const o = document.createElement("option");
    o.value = value; o.textContent = label;
    return o;
  };

  movMember.innerHTML = "";
  movMember.appendChild(opt("", "‚Äî"));
  fMember.innerHTML = "";
  fMember.appendChild(opt("", "Todos"));
  histMember.innerHTML = "";
  histMember.appendChild(opt("", "‚Äî"));

  list.forEach(m=>{
    movMember.appendChild(opt(m.id, m.name));
    fMember.appendChild(opt(m.id, m.name));
    histMember.appendChild(opt(m.id, m.name));
  });

  movMember.value = selectedMov;
  fMember.value = selectedFilter;
  histMember.value = selectedHist;
}

function getLateMembers(){
  const today = parseISO(isoToday()).getTime();
  return DB.members.filter(m=>{
    const due = parseISO(m.due);
    if(!due) return false;
    return due.getTime() < today;
  });
}

function getDashRangeDates(){
  const mode = document.getElementById("dashRange").value;
  const today = isoToday();
  if(mode==="today") return {from: today, to: today};
  if(mode==="7") return {from: shiftISO(today, -6), to: today};
  if(mode==="30") return {from: shiftISO(today, -29), to: today};
  if(mode==="month"){
    const d = parseISO(today);
    const first = new Date(d.getFullYear(), d.getMonth(), 1);
    const off = first.getTimezoneOffset();
    const local = new Date(first.getTime() - off*60000);
    return {from: local.toISOString().slice(0,10), to: today};
  }
  return {from: null, to: null};
}

document.getElementById("dashRange").addEventListener("change", renderDashboard);
document.getElementById("dashType").addEventListener("change", renderDashboard);

function renderAll(){
  // local gym name
  const savedName = localStorage.getItem("gym_name_local");
  if(savedName && !DB.settings.gymName) DB.settings.gymName = savedName;
  if(savedName) DB.settings.gymName = savedName;

  document.getElementById("gymNameSide").textContent = DB.settings.gymName || "Financeiro Completo";
  document.getElementById("setGymName").value = DB.settings.gymName || "";

  // Admin-only: esconder abas no menu para funcion√°rio
  const navSettings = document.getElementById("navSettings");
  if(navSettings) navSettings.classList.toggle("hide", !isAdmin());
  const navUsers = document.getElementById("navUsers");
  if(navUsers) navUsers.classList.toggle("hide", !isAdmin());

  // Preenche funcion√°rio automaticamente no formul√°rio
  document.getElementById("movStaff").value = currentUserName();

  // cash status
  const status = cashStatusText();
  document.getElementById("cashStatusPill").textContent = `Caixa: ${status}`;
  const tag = document.getElementById("cashTag");
  const tag2 = document.getElementById("cashTag2");
  const openedAt = DB.cash.openedAt ? new Date(DB.cash.openedAt).toLocaleString("pt-BR") : "‚Äî";
  document.getElementById("cashOpenedAt").textContent = DB.cash.openedAt ? `Aberto: ${openedAt}` : "‚Äî";
  const tText = DB.cash.isOpen ? `üü¢ Caixa ABERTO (${DB.cash.openedBy||"‚Äî"})` : `üî¥ Caixa FECHADO`;
  tag.textContent = tText;
  tag2.textContent = tText;
  tag.className = "tag " + (DB.cash.isOpen ? "good" : "bad");
  tag2.className = tag.className;

  document.getElementById("btnOpenCash").disabled = DB.cash.isOpen;
  document.getElementById("btnCloseCash").disabled = !DB.cash.isOpen;

  const lockMsg = document.getElementById("cashLockMsg");
  lockMsg.textContent = DB.cash.isOpen ? "" : "‚ö†Ô∏è Caixa fechado: abra o caixa para registrar movimenta√ß√µes.";
  document.getElementById("cashHint").textContent = DB.cash.isOpen
    ? "Caixa aberto: registre entradas e sa√≠das do dia."
    : "Abra o caixa para registrar movimenta√ß√µes do dia.";

  // set default dates
  const movDate = document.getElementById("movDate");
  if(!movDate.value) movDate.value = isoToday();

  // populate member selects
  fillMemberSelects();

  // late badge
  const late = getLateMembers();
  const badge = document.getElementById("lateBadge");
  if(late.length>0){
    badge.classList.remove("hide");
    badge.textContent = `${late.length} atrasados`;
  }else{
    badge.classList.add("hide");
  }

  renderDashboard();
  renderMovesTable();
  renderMembers();
}

function renderDashboard(){
  const {from,to} = getDashRangeDates();
  const typeFilter = document.getElementById("dashType").value;

  const moves = DB.moves.filter(m=>{
    if(!inRange(m.date, from, to)) return false;
    if(typeFilter!=="all" && m.type!==typeFilter) return false;
    return true;
  });

  const sumIn = moves.filter(m=>m.type==="income").reduce((a,b)=>a+b.amount,0);
  const sumOut = moves.filter(m=>m.type==="expense").reduce((a,b)=>a+b.amount,0);
  const bal = sumIn - sumOut;

  document.getElementById("kpiIn").textContent = moneyBR(sumIn);
  document.getElementById("kpiOut").textContent = moneyBR(sumOut);
  document.getElementById("kpiBal").textContent = moneyBR(bal);

  const periodLabel = from && to ? `${fmtDateBR(from)} ‚Üí ${fmtDateBR(to)}` : "Tudo";
  document.getElementById("kpiInMini").textContent = periodLabel;
  document.getElementById("kpiOutMini").textContent = periodLabel;
  document.getElementById("kpiBalMini").textContent = periodLabel;

  const late = getLateMembers();
  document.getElementById("kpiLate").textContent = late.length;

  // Top categories
  const catMap = new Map();
  moves.forEach(m=>{
    const key = `${m.cat}__${m.type}`;
    catMap.set(key, (catMap.get(key)||0) + m.amount);
  });
  const catRows = [...catMap.entries()]
    .map(([k,v])=>{
      const [cat, type] = k.split("__");
      return {cat, type, total:v};
    })
    .sort((a,b)=>b.total-a.total)
    .slice(0,8);

  const topCatsBody = document.getElementById("topCatsBody");
  topCatsBody.innerHTML = "";
  if(catRows.length===0){
    topCatsBody.innerHTML = `<tr><td colspan="3" class="muted">Sem dados no per√≠odo.</td></tr>`;
  }else{
    catRows.forEach(r=>{
      const typeTag = r.type==="income"
        ? `<span class="tag good">Entrada</span>`
        : `<span class="tag bad">Sa√≠da</span>`;
      topCatsBody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${r.cat}</td>
          <td>${typeTag}</td>
          <td class="right mono">${moneyBR(r.total)}</td>
        </tr>
      `);
    });
  }

  // Pay methods
  const payMap = new Map();
  moves.forEach(m=>{
    payMap.set(m.pay, (payMap.get(m.pay)||0) + m.amount);
  });
  const payRows = [...payMap.entries()].map(([pay,total])=>({pay,total}))
    .sort((a,b)=>b.total-a.total)
    .slice(0,8);

  const payBody = document.getElementById("payMethodsBody");
  payBody.innerHTML = "";
  if(payRows.length===0){
    payBody.innerHTML = `<tr><td colspan="2" class="muted">Sem dados no per√≠odo.</td></tr>`;
  }else{
    payRows.forEach(r=>{
      payBody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${r.pay}</td>
          <td class="right mono">${moneyBR(r.total)}</td>
        </tr>
      `);
    });
  }

  // last moves
  const lastMovesBody = document.getElementById("lastMovesBody");
  lastMovesBody.innerHTML = "";
  DB.moves.slice(0,8).forEach(m=>{
    const sign = m.type==="income" ? "+" : "‚àí";
    const cls = m.type==="income" ? "good" : "bad";
    lastMovesBody.insertAdjacentHTML("beforeend", `
      <tr>
        <td class="mono">${fmtDateBR(m.date)}</td>
        <td>
          <div style="font-weight:800">${m.desc}</div>
          <div class="muted">${m.cat} ‚Ä¢ ${m.pay}</div>
        </td>
        <td class="right mono"><span class="tag ${cls}">${sign} ${moneyBR(m.amount)}</span></td>
      </tr>
    `);
  });
  if(DB.moves.length===0){
    lastMovesBody.innerHTML = `<tr><td colspan="3" class="muted">Sem movimenta√ß√µes.</td></tr>`;
  }

  // cash open info
  document.getElementById("cashOpenedAt").textContent = DB.cash.openedAt
    ? `Aberto: ${new Date(DB.cash.openedAt).toLocaleString("pt-BR")}`
    : "‚Äî";
}

function renderMovesTable(){
  const from = document.getElementById("fFrom").value || null;
  const to = document.getElementById("fTo").value || null;
  const type = document.getElementById("fType").value;
  const member = document.getElementById("fMember").value || "";
  const q = (document.getElementById("fSearch").value || "").trim().toLowerCase();

  const rows = DB.moves.filter(m=>{
    if(!inRange(m.date, from, to)) return false;
    if(type!=="all" && m.type!==type) return false;
    if(member && m.memberId!==member) return false;
    if(q){
      const mem = DB.members.find(x=>x.id===m.memberId);
      const hay = [
        m.cat, m.desc, m.note, m.staff, m.pay,
        mem?mem.name:""
      ].join(" ").toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });

  const body = document.getElementById("movTableBody");
  body.innerHTML = "";
  let sumIn=0, sumOut=0;

  rows.forEach(m=>{
    const mem = DB.members.find(x=>x.id===m.memberId);
    const t = m.type==="income" ? `<span class="tag good">Entrada</span>` : `<span class="tag bad">Sa√≠da</span>`;
    const valTag = m.type==="income"
      ? `<span class="tag good mono">+ ${moneyBR(m.amount)}</span>`
      : `<span class="tag bad mono">‚àí ${moneyBR(m.amount)}</span>`;

    if(m.type==="income") sumIn += m.amount;
    else sumOut += m.amount;

    const btnDel = isAdmin()
      ? `<button class="btn danger" onclick="deleteMove('${m.id}')">Excluir</button>`
      : `<span class="muted">‚Äî</span>`;

    body.insertAdjacentHTML("beforeend", `
      <tr>
        <td class="mono">${fmtDateBR(m.date)}</td>
        <td>${t}</td>
        <td>${m.cat}</td>
        <td>
          <div style="font-weight:800">${m.desc}</div>
          ${m.note ? `<div class="muted">${m.note}</div>` : `<div class="muted">‚Äî</div>`}
        </td>
        <td>${mem ? mem.name : "‚Äî"}</td>
        <td>${m.pay}</td>
        <td>${m.staff || "‚Äî"}</td>
        <td class="right">${valTag}</td>
        <td class="right">${btnDel}</td>
      </tr>
    `);
  });

  if(rows.length===0){
    body.innerHTML = `<tr><td colspan="9" class="muted">Nenhuma movimenta√ß√£o encontrada.</td></tr>`;
  }

  document.getElementById("movCount").textContent = `${rows.length} registro(s) no filtro`;
  document.getElementById("movSumIn").textContent = `Entradas: ${moneyBR(sumIn)}`;
  document.getElementById("movSumOut").textContent = `Sa√≠das: ${moneyBR(sumOut)}`;
  document.getElementById("movSumBal").textContent = `Saldo: ${moneyBR(sumIn - sumOut)}`;
}

function renderMembers(){
  const q = (document.getElementById("mSearch").value || "").trim().toLowerCase();
  const status = document.getElementById("mStatus").value;

  const today = parseISO(isoToday()).getTime();
  const list = DB.members
    .filter(m=>{
      const isLate = parseISO(m.due)?.getTime() < today;
      if(status==="ok" && isLate) return false;
      if(status==="late" && !isLate) return false;

      if(q){
        const hay = [m.name,m.phone,m.plan,m.due,m.notes].join(" ").toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    })
    .sort((a,b)=>a.name.localeCompare(b.name));

  const body = document.getElementById("membersBody");
  body.innerHTML = "";

  list.forEach(m=>{
    const isLate = parseISO(m.due)?.getTime() < today;
    const st = isLate ? `<span class="tag bad">Atrasado</span>` : `<span class="tag good">Em dia</span>`;
    const btnDel = isAdmin()
      ? `<button class="btn danger" onclick="deleteMember('${m.id}')">Excluir</button>`
      : ``;
    body.insertAdjacentHTML("beforeend", `
      <tr>
        <td>
          <div style="font-weight:900">${m.name}</div>
          ${m.notes ? `<div class="muted">${m.notes}</div>` : `<div class="muted">‚Äî</div>`}
        </td>
        <td>${m.plan || "‚Äî"}</td>
        <td class="mono">${fmtDateBR(m.due)}</td>
        <td>${st}</td>
        <td>${m.phone || "‚Äî"}</td>
        <td class="right">
          <button class="btn" onclick="editMember('${m.id}')">Editar</button>
          ${btnDel}
        </td>
      </tr>
    `);
  });

  if(list.length===0){
    body.innerHTML = `<tr><td colspan="6" class="muted">Nenhum aluno encontrado.</td></tr>`;
  }
}
document.getElementById("mSearch").addEventListener("input", renderMembers);
document.getElementById("mStatus").addEventListener("change", renderMembers);

document.getElementById("btnHistLoad").addEventListener("click", ()=>{
  const id = document.getElementById("histMember").value;
  const body = document.getElementById("histBody");
  body.innerHTML = "";
  if(!id){
    body.innerHTML = `<tr><td colspan="5" class="muted">Selecione um aluno.</td></tr>`;
    document.getElementById("histCount").textContent = "‚Äî";
    document.getElementById("histSum").textContent = `Total: ${moneyBR(0)}`;
    return;
  }
  const rows = DB.moves.filter(m=>m.type==="income" && m.memberId===id)
    .slice()
    .sort((a,b)=> parseISO(b.date)-parseISO(a.date));

  let sum = 0;
  rows.forEach(m=>{
    sum += m.amount;
    body.insertAdjacentHTML("beforeend", `
      <tr>
        <td class="mono">${fmtDateBR(m.date)}</td>
        <td>${m.cat}</td>
        <td>${m.desc}</td>
        <td>${m.pay}</td>
        <td class="right"><span class="tag good mono">+ ${moneyBR(m.amount)}</span></td>
      </tr>
    `);
  });

  if(rows.length===0){
    body.innerHTML = `<tr><td colspan="5" class="muted">Sem entradas vinculadas a este aluno.</td></tr>`;
  }
  document.getElementById("histCount").textContent = `${rows.length} entrada(s)`;
  document.getElementById("histSum").textContent = `Total: ${moneyBR(sum)}`;
});


async function generateCloseDayPDF(dayISO){
  if(!window.jspdf || !window.jspdf.jsPDF){
    toast("PDF indispon√≠vel", "Biblioteca jsPDF n√£o carregou. Verifique sua internet.");
    return;
  }
  // garante dados atuais
  await loadAll();

  const movesDay = DB.moves.filter(m => m.date === dayISO);
  const sumIn = movesDay.filter(m=>m.type==="income").reduce((a,b)=>a+Number(b.amount||0),0);
  const sumOut = movesDay.filter(m=>m.type==="expense").reduce((a,b)=>a+Number(b.amount||0),0);
  const bal = sumIn - sumOut;

  const byPay = {};
  const byPayIn = {};
  const byPayOut = {};
  movesDay.forEach(m=>{
    const k = m.pay || "‚Äî";
    byPay[k] = (byPay[k]||0) + Number(m.amount||0);
    if(m.type==="income") byPayIn[k] = (byPayIn[k]||0) + Number(m.amount||0);
    else byPayOut[k] = (byPayOut[k]||0) + Number(m.amount||0);
  });

  const incomes = movesDay.filter(m=>m.type==="income");
  const expenses = movesDay.filter(m=>m.type==="expense");

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt", format:"a4"});

  const left = 40;
  let y = 44;

  const title = `Fechamento do Dia ‚Ä¢ ${DB.settings.gymName || "Academia"}`;
  doc.setFont("helvetica","bold"); doc.setFontSize(14);
  doc.text(title, left, y); y += 18;
  doc.setFont("helvetica","normal"); doc.setFontSize(10);
  doc.text(`Data: ${fmtDateBR(dayISO)}   Gerado em: ${new Date().toLocaleString("pt-BR")}`, left, y); y += 16;
  doc.text(`Respons√°vel (logado): ${currentUserName()}`, left, y); y += 18;

  doc.setFont("helvetica","bold"); doc.setFontSize(11);
  doc.text(`Resumo`, left, y); y += 12;
  doc.setFont("helvetica","normal"); doc.setFontSize(10);
  doc.text(`Entradas: ${moneyBR(sumIn)}   Sa√≠das: ${moneyBR(sumOut)}   Saldo: ${moneyBR(bal)}`, left, y); y += 18;

  doc.setFont("helvetica","bold"); doc.text("Entradas por m√©todo", left, y); y += 12;
  doc.setFont("helvetica","normal");
  const payKeys = Object.keys(byPayIn).sort((a,b)=>byPayIn[b]-byPayIn[a]);
  if(payKeys.length===0){ doc.text("‚Äî", left, y); y += 14; }
  payKeys.forEach(k=>{ doc.text(`${k}: ${moneyBR(byPayIn[k])}`, left, y); y += 14; });

  y += 6;
  doc.setFont("helvetica","bold"); doc.text("Sa√≠das por m√©todo", left, y); y += 12;
  doc.setFont("helvetica","normal");
  const payKeys2 = Object.keys(byPayOut).sort((a,b)=>byPayOut[b]-byPayOut[a]);
  if(payKeys2.length===0){ doc.text("‚Äî", left, y); y += 14; }
  payKeys2.forEach(k=>{ doc.text(`${k}: ${moneyBR(byPayOut[k])}`, left, y); y += 14; });

  y += 10;
  doc.setFont("helvetica","bold"); doc.text(`Movimenta√ß√µes do dia (${movesDay.length})`, left, y); y += 12;
  doc.setFont("helvetica","normal"); doc.setFontSize(9);

  const line = (t)=>{
    if(y > 760){ doc.addPage(); y = 44; }
    doc.text(t, left, y); y += 12;
  };

  // Entradas
  doc.setFont("helvetica","bold"); doc.setFontSize(10);
  line("Entradas:");
  doc.setFont("helvetica","normal"); doc.setFontSize(9);
  if(incomes.length===0) line("‚Äî");
  incomes.forEach(m=>{
    const mem = DB.members.find(x=>x.id===m.memberId) || null;
    line(`+ ${moneyBR(m.amount)} | ${m.pay} | ${m.cat} | ${mem?mem.name:"‚Äî"} | ${m.desc}`);
  });

  y += 8;
  doc.setFont("helvetica","bold"); doc.setFontSize(10);
  line("Sa√≠das:");
  doc.setFont("helvetica","normal"); doc.setFontSize(9);
  if(expenses.length===0) line("‚Äî");
  expenses.forEach(m=>{
    line(`- ${moneyBR(m.amount)} | ${m.pay} | ${m.cat} | ${m.desc}`);
  });

  y += 18;
  doc.setFont("helvetica","normal"); doc.setFontSize(10);
  line("Assinatura: ________________________________");

  const fileName = `fechamento_${dayISO}_${(DB.settings.gymName||"academia").replace(/\s+/g,'_')}.pdf`;
  doc.save(fileName);
  toast("PDF gerado", "Fechamento do dia baixado.");
}

function renderReport(){
  const from = document.getElementById("rFrom").value || null;
  const to = document.getElementById("rTo").value || null;
  const group = document.getElementById("rGroup").value;
  const type = document.getElementById("rType").value;

  const moves = DB.moves.filter(m=>{
    if(!inRange(m.date, from, to)) return false;
    if(type!=="all" && m.type!==type) return false;
    return true;
  });

  const sumIn = moves.filter(m=>m.type==="income").reduce((a,b)=>a+b.amount,0);
  const sumOut = moves.filter(m=>m.type==="expense").reduce((a,b)=>a+b.amount,0);

  document.getElementById("rSumIn").textContent = `Entradas: ${moneyBR(sumIn)}`;
  document.getElementById("rSumOut").textContent = `Sa√≠das: ${moneyBR(sumOut)}`;
  document.getElementById("rSumBal").textContent = `Saldo: ${moneyBR(sumIn - sumOut)}`;
  document.getElementById("rCount").textContent = `${moves.length} movimenta√ß√£o(√µes) no per√≠odo`;

  const keyOf = (m)=>{
    if(group==="day") return m.date;
    if(group==="cat") return m.cat;
    if(group==="pay") return m.pay;
    if(group==="staff") return m.staff || "‚Äî";
    return "‚Äî";
  };

  const map = new Map();
  moves.forEach(m=>{
    const k = `${keyOf(m)}__${m.type}`;
    const cur = map.get(k) || {group:keyOf(m), type:m.type, total:0, count:0};
    cur.total += m.amount;
    cur.count += 1;
    map.set(k, cur);
  });

  const rows = [...map.values()].sort((a,b)=>b.total-a.total);

  const body = document.getElementById("reportBody");
  body.innerHTML = "";
  if(rows.length===0){
    body.innerHTML = `<tr><td colspan="4" class="muted">Sem dados para o per√≠odo.</td></tr>`;
    return;
  }

  rows.forEach(r=>{
    const t = r.type==="income" ? `<span class="tag good">Entrada</span>` : `<span class="tag bad">Sa√≠da</span>`;
    body.insertAdjacentHTML("beforeend", `
      <tr>
        <td class="mono">${group==="day" ? fmtDateBR(r.group) : r.group}</td>
        <td>${t}</td>
        <td class="right mono">${moneyBR(r.total)}</td>
        <td class="right mono">${r.count}</td>
      </tr>
    `);
  });
}

/* =============================
   INIT
============================= */
(async function init(){
  // bloqueia se n√£o setou supabase
  if(!SUPABASE_URL.includes("http") || SUPABASE_ANON_KEY.includes("COLE_AQUI")){
    toast("Configura√ß√£o", "Cole SUPABASE_URL e SUPABASE_ANON_KEY no c√≥digo.");
  }

  // tenta restaurar sess√£o
  const { data } = await sb.auth.getSession();
  const session = data.session;

  if(session && session.user){
    try{
      DB.profile = await ensureProfile(session.user);
      if(DB.profile.active !== true){
        await sb.auth.signOut();
        DB.profile = null;
        renderAuth(false);
        toast("Acesso bloqueado", "Seu usu√°rio est√° inativo. Fale com o admin.");
        return;
      }
      renderAuth(true);
      await loadAll();
    }catch(e){
      renderAuth(false);
    }
  } else {
    renderAuth(false);
  }

  setTab("dashboard");

  // se entrar na aba users, renderiza listagem
  document.getElementById("navUsers")?.addEventListener("click", ()=> setTimeout(()=>renderUsers(), 50));
})();
</script>
</body>
</html>
